# Define VerneMQ version
ARG TARGET_VERNE_MQ_VERSION=latest

FROM vernemq/vernemq:${TARGET_VERNE_MQ_VERSION}

# VerneMQ configuration env variables
ENV DOCKER_VERNEMQ_LOG__CONSOLE=console \
    DOCKER_VERNEMQ_ACCEPT_EULA=yes \
    DOCKER_VERNEMQ_LISTENER__TCP__DEFAULT=0.0.0.0:1883 \
    DOCKER_VERNEMQ_LISTENER__SSL__DEFAULT=0.0.0.0:8883 \
    DOCKER_VERNEMQ_LISTENER__HTTP__DEFAULT=0.0.0.0:8989 \
    # DOCKER_VERNEMQ_LISTENER__SSL__CERTFILE=/vernemq/certs/cert.pem \
    # DOCKER_VERNEMQ_LISTENER__SSL__KEYFILE=/vernemq/certs/key.pem \
    DOCKER_VERNEMQ_PLUGINS__VMQ_ACL=off \
    DOCKER_VERNEMQ_PLUGINS__VMQ_PASSWD=off \
    DOCKER_VERNEMQ_PLUGINS__VMQ_DIVERSITY=on \
    DOCKER_VERNEMQ_VMQ_DIVERSITY__AUTH_MYSQL__ENABLED=on \
    DOCKER_VERNEMQ_VMQ_DIVERSITY__MYSQL__PASSWORD_HASH_METHOD=sha256
    # DOCKER_VERNEMQ_VMQ_DIVERSITY__HTTP_AUTH__FILE=/vernemq/share/lua/auth/auth_http.lua

################################
# CONTAINER REQUIRED ARGUMENTS #
################################

# Docker file path
ARG SERVICE_DIR="./containers/vernemq"
# API service host
# ARG APP_API_HOST=io-fastybird.local
# API service host API key
# ARG APP_API_KEY=71298d56-a27f-4220-90c9-a36ba7e151d7

# VerneMQ is switched to vernemq user by default
USER root

#############################
# CONTAINER INSTALL HELPERS #
#############################

# Copy helper scripts to docker image
COPY ./shared/scripts/ /tmp/scripts/
# Set access rights to this scripts
RUN chmod +x -R /tmp/scripts/

##############################
# CONFIGURE SSL CERTIFICATES #
##############################

# Copy ssl certificates generated by letsencrypt or other authority
COPY ./.ssl/ /vernemq/certs/
# Set access for certificates for venemq default user
RUN chown -R vernemq:vernemq /vernemq/certs

####################
# VERNE MQ SCRIPTS #
####################

# VerneMQ auth lua plugin
# COPY ${SERVICE_DIR}/scripts/auth_http.lua /vernemq/share/lua/auth/auth_http.lua

# RUN /tmp/scripts/modify_config.sh /vernemq/share/lua/auth/auth_http.lua \
#     "__APP_API_HOST" \
#     "${APP_API_HOST}" \
#  && /tmp/scripts/modify_config.sh /vernemq/share/lua/auth/auth_http.lua \
#     "__APP_API_KEY" \
#     "${APP_API_KEY}" \
# ;

# Set access rights to scripts
# RUN chown vernemq:vernemq /vernemq/share/lua/auth/auth_http.lua

#####################################
# FINISHING CONTAINER CONFIGURATION #
#####################################

# Set back vernemq user to be able to start service
USER vernemq

# Ports
# 1883  : MQTT
# 8883  : MQTT/SSL
# 8989  : Prometheus Metrics
# 8080  : MQTT WebSockets
# 44053 : VerneMQ Message Distribution
# 4369  : EPMD - Erlang Port Mapper Daemon
# 9100 9101 9102 9103 9104 9105 9106 9107 9108 9109  Specific Distributed Erlang Port Range

EXPOSE 1883 8883 8989
